<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>三角比タイムアタック</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"> <!-- スマホ対応 -->
  <style>
    :root{
      --bg:#f5f5f5; --fg:#111; --accent:#1976d2; --ok:#2e7d32; --ng:#d32f2f;
    }
    html,body{height:100%;}
    body{
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
                   "Noto Sans JP","Hiragino Sans","Yu Gothic", Meiryo, Arial, sans-serif;
      color:var(--fg); background-color:var(--bg);
      text-align:center; margin:0; padding:16px;
    }
    h1{ font-size: clamp(20px, 5vw, 28px); margin: 8px 0 16px; }
    .button{
      padding: 12px 16px;
      margin: 8px;
      font-size: clamp(16px, 4.5vw, 20px);
      min-width: 120px; min-height: 44px; /* 指で押しやすい */
      border: 1px solid #ccc; border-radius: 10px; background:#fff; color:#111;
      touch-action: manipulation; cursor:pointer;
    }
    .button:active{ transform: translateY(1px); }
    .question{ font-size: clamp(18px, 5.5vw, 24px); margin: 12px; }
    .options{
      display:flex; flex-wrap:wrap; justify-content:center; gap:10px;
      max-width: 720px; margin: 0 auto 8px;
    }
    .result{ font-size: clamp(16px, 4.5vw, 20px); margin: 8px; font-weight: bold; white-space: pre-wrap; min-height: 1.5em; }
    #timer,#score{ font-size: clamp(14px, 4vw, 18px); margin: 4px 0; }

    /* 分数を縦に表示するためのスタイル */
    .frac{
      display:inline-block; text-align:center; vertical-align:middle; line-height:1.1;
      font-size: inherit;
    }
    .frac .top{ display:block; padding:0 4px; }
    .frac .bar{ display:block; border-top: 1px solid currentColor; margin: 2px 0; }
    .frac .bottom{ display:block; padding:0 4px; }

    /* 画面切り替え */
    .start-screen, .quiz-screen{ display:none; }
    .wrap{ max-width: 900px; margin: 0 auto; }
    select{ font-size: 16px; padding:6px 8px; }
    label{ font-size: clamp(14px, 4vw, 18px); }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>三角比タイムアタック</h1>

    <div class="start-screen" id="startScreen">
      <label>レベル:
        <select id="level">
          <option value="1">レベル1（30°,45°,60°）</option>
          <option value="2">レベル2（0°〜180°）</option>
          <option value="3">レベル3（0°〜360°）（数学Ⅱ）</option>
        </select>
      </label>
      <br>
      <button class="button" id="startButton">スタート</button>
    </div>

    <div class="quiz-screen" id="quizScreen">
      <div class="question" id="question"></div>
      <div class="options" id="options"></div>
      <div class="result" id="result"></div>
      <div id="timer">残り時間: 60秒</div>
      <div id="score">スコア: 0 / 0 (0%)</div>
    </div>
  </div>

  <script>
    // 出題角
    const angles = {
      1:[30,45,60],
      2:[0,30,45,60,90,120,135,150,180],
      3:[0,30,45,60,90,120,135,150,180,210,225,240,270,300,315,330,360]
    };
    const funcs = ['sin','cos','tan'];

    let score=0, total=0, time=60, timer;

    // 30/45/60 を用いた厳密値を返す（度）
    function exact(f, deg){
      // 0..359へ正規化（360は特別扱い）
      let k = ((deg % 360) + 360) % 360;
      if (deg === 360) k = 0;

      // 特殊角（未定義や0,±1）
      if (f === 'tan' && (k === 90 || k === 270)) return '未定義';
      if (f === 'sin' && (k === 0 || k === 180)) return '0';
      if (f === 'cos' && (k === 90 || k === 270)) return '0';
      if (f === 'sin' && k === 90) return '1';
      if (f === 'sin' && k === 270) return '-1';
      if (f === 'cos' && (k === 0)) return '1';
      if (f === 'cos' && (k === 180)) return '-1';
      if (f === 'tan' && (k === 0 || k === 180)) return '0';

      // 基本値（30,45,60）
      const base = {
        sin:{30:'1/2',45:'1/√2',60:'√3/2'},
        cos:{30:'√3/2',45:'1/√2',60:'1/2'},
        tan:{30:'1/√3',45:'1',60:'√3'}
      };

      // 基準角（0〜90）
      let ref;
      if (k <= 90) ref = k;
      else if (k <= 180) ref = 180 - k;
      else if (k <= 270) ref = k - 180;
      else ref = 360 - k;

      // 30・45・60のみ出題される設計なのでそのまま参照
      const v = base[f][ref];
      if (!v) return '0'; // 念のため

      // 符号決定
      let sign = 1;
      if (f === 'sin') sign = (k < 180) ? 1 : -1;               // Q1,Q2:+ / Q3,Q4:-
      if (f === 'cos') sign = (k < 90 || k > 270) ? 1 : -1;     // Q1,Q4:+ / Q2,Q3:-
      if (f === 'tan') sign = ( (k < 90) || (k > 180 && k < 270) ) ? 1 : -1; // Q1,Q3:+ / Q2,Q4:-

      if (sign === -1) {
        if (v === '1') return '-1';
        if (v === '0') return '0';
        return '-' + v;
      }
      return v;
    }

    // 画面表示用（分数は縦並び）
    function formatForDisplay(value){
      if (value.includes('/')){
        const [num, den] = value.split('/');
        return `<span class="frac"><span class="top">${num}</span><span class="bar"></span><span class="bottom">${den}</span></span>`;
      }
      return `<span>${value}</span>`;
    }

    function nextQuestion(){
      document.getElementById('result').innerHTML='';
      const lvl = parseInt(document.getElementById('level').value);
      const a = angles[lvl][Math.floor(Math.random() * angles[lvl].length)];
      const f = funcs[Math.floor(Math.random() * funcs.length)];
      document.getElementById('question').innerHTML = `${f} ${a}° = ?`;

      const correct = exact(f,a);
      total++;

      // 選択肢
      let opts = new Set([correct]);
      const vals = ["0","1/2","1/√2","√3/2","1","1/√3","√3","-1/2","-1/√2","-√3/2","-1","-1/√3","-√3","未定義"];
      while(opts.size < 4) opts.add(vals[Math.floor(Math.random()*vals.length)]);
      const shuffled = Array.from(opts).sort(()=>Math.random()-0.5);

      const div = document.getElementById('options');
      div.innerHTML='';
      shuffled.forEach(o=>{
        const b = document.createElement('button');
        b.className='button';
        b.innerHTML = formatForDisplay(o);
        b.onclick = ()=>{
          if(o === correct){
            document.getElementById('result').innerHTML = '<span style="color:var(--ok)">正解！</span>';
            score += 1;
            setTimeout(()=>{ nextQuestion(); }, 400);
          } else {
            document.getElementById('result').innerHTML = '<span style="color:var(--ng)">不正解 ペナルティ3秒</span>';
            setTimeout(()=>{ nextQuestion(); }, 3000);
          }
          document.getElementById('score').innerText = `スコア: ${score} / ${total} (${Math.round(score/total*100)}%)`;
        };
        div.appendChild(b);
      });
    }

    function startQuiz(){
      score=0; total=0; time=60;
      document.getElementById('startScreen').style.display='none';
      document.getElementById('quizScreen').style.display='block';
      nextQuestion();
      clearInterval(timer);
      timer = setInterval(()=>{
        time--;
        document.getElementById('timer').innerText = `残り時間: ${time}秒`;
        if(time <= 0){
          clearInterval(timer);
          document.getElementById('quizScreen').innerHTML =
            `<h2>時間切れ！</h2><p>最終スコア: ${score}/${total} (${Math.round(score/total*100)}%)</p><button class="button" onclick="location.reload()">もう一度</button>`;
        }
      }, 1000);
    }

    document.getElementById('startButton').onclick = startQuiz;
    document.getElementById('startScreen').style.display='block';
  </script>
</body>
</html>
